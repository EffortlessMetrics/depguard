name: Conformance

on:
  push:
    branches: [main]
    paths:
      - 'schemas/**'
      - 'contracts/**'
      - 'crates/depguard-types/**'
      - 'crates/depguard-settings/**'
      - 'tests/fixtures/**'
      - '.github/workflows/conformance.yml'
  pull_request:
    branches: [main]
    paths:
      - 'schemas/**'
      - 'contracts/**'
      - 'crates/depguard-types/**'
      - 'crates/depguard-settings/**'
      - 'tests/fixtures/**'
      - '.github/workflows/conformance.yml'

env:
  CARGO_TERM_COLOR: always

jobs:
  schema-conformance:
    name: Schema Conformance
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Validate schemas match generated output
        run: cargo run -p xtask -- validate-schemas
      - name: Validate sensor.report.v1 conformance
        run: cargo run -p xtask -- conform

  contract-fixture-validation:
    name: Contract Fixture Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Validate contract fixtures against sensor.report.v1 schema
        run: cargo run -p xtask -- conform

  sensor-v1-conformance:
    name: Sensor V1 Conformance
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Build depguard
        run: cargo build -p depguard-cli
      - name: Run full conformance (contract fixtures + depguard output)
        run: cargo run -p xtask -- conform-full

  explain-coverage:
    name: Explain Coverage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Validate all check IDs and codes have explanations
        run: cargo run -p xtask -- explain-coverage

  fixture-validation:
    name: Fixture Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Run conformance tests
        run: cargo test -p depguard-cli --test conformance

  report-format-validation:
    name: Report Format Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2

      - name: Build depguard
        run: cargo build --release -p depguard-cli

      - name: Test v1 report format
        run: |
          ./target/release/depguard check \
            --report-version v1 \
            --report-out /tmp/report-v1.json \
            tests/fixtures/wildcards
          # Verify v1 schema
          jq -e '.schema_id == "depguard.report.v1" or .schema == "depguard.report.v1"' /tmp/report-v1.json

      - name: Test v2 report format
        run: |
          ./target/release/depguard check \
            --report-version v2 \
            --report-out /tmp/report-v2.json \
            tests/fixtures/wildcards
          # Verify v2 schema and structure
          jq -e '.schema == "depguard.report.v2"' /tmp/report-v2.json
          jq -e '.verdict.status' /tmp/report-v2.json
          jq -e '.run.started_at' /tmp/report-v2.json

      - name: Test sensor-v1 report format
        run: |
          ./target/release/depguard check \
            --report-version sensor-v1 \
            --report-out /tmp/report-sensor-v1.json \
            tests/fixtures/wildcards
          # Verify sensor.report.v1 schema and required fields
          jq -e '.schema == "sensor.report.v1"' /tmp/report-sensor-v1.json
          jq -e '.tool.name == "depguard"' /tmp/report-sensor-v1.json
          jq -e '.run' /tmp/report-sensor-v1.json
          jq -e '.verdict' /tmp/report-sensor-v1.json
          jq -e '.findings' /tmp/report-sensor-v1.json
